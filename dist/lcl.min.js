/*!
 * @Project: lcl
 * @Version: v1.3.0 
 * @Author: PengJiyuan 
 * @Date: 2017-01-13
 * @license: MIT
 *
 * @homepage: https://github.com/PengJiyuan/LCL#readme
 */
!function(){LCL=function(){this.version="1.3.0",this.objects=[],this.canvas=null,this.transX=0,this.transY=0,this.scale=1,this.drawUtils={},this.loader=null,this.images=[],this.isDragging=!1,this.eventTypes=["mousedown","mouseup","mouseenter","mouseleave","mousemove","drag","dragend","dragin","dragout","drop"],this._event=new this.event(this);var a=this;this.core=function(b){return b instanceof Object?(this.element=a.element=b.element,this.canvas=a.canvas=this.element.getContext("2d"),b.element.width=this.width=a.width=b.width,b.element.height=this.height=a.height=b.height,a.enableGlobalTranslate=b.enableGlobalTranslate,a.drawUtils.clear=this.clear,a.drawUtils.draw=this.draw,a.drawUtils.redraw=this.redraw,void(b.images&&(a.images=b.images))):void console.warn("no canvas element!")},this.core.prototype={imgReady:function(){a.loader=new a.utils.imageLoader,a.loader.addImg(a.images)},addChild:function(b){a.objects.push(b),a._objects=a.utils.reverse(a.objects)},show:function(){this.imgReady(),a.loader.ready(function(){a.drawUtils.draw(),a._event.triggerEvents()})},draw:function(){a.objects.forEach(function(a){a.draw()})},redraw:function(){a.drawUtils.clear(),a.canvas.save(),a.canvas.translate(a.transX,a.transY),a.drawUtils.draw(),a.canvas.restore()},clear:function(){a.canvas.clearRect(0,0,a.width,a.height)},animate:function(b,c){a._event.triggerEvents();var d=(new Date).getTime(),e=function(){b(),a[d]=requestAnimationFrame(e)};return e(),d},stop:function(b){cancelAnimationFrame(a[b])},globalTranslate:function(b){"boolean"==typeof b&&b&&(a.enableGlobalTranslate=!0)}},this.init=function(b){return new a.core(b)}},LCL.prototype.display=function(a){var b=this,c={fillColor:a.fillColor,sliceX:a.sliceX,sliceY:a.sliceY,width:a.width,height:a.height,sliceWidth:a.sliceWidth,sliceHeight:a.sliceHeight,backgroundColor:a.backgroundColor,text:a.text},d=function(a,c){if(!a)throw"no eventTypes defined!";if(!c||"function"!=typeof c)throw"you need defined a callback!";this.events=this.events||[];var d=a.split(" "),e=this;return d.forEach(function(a){~b.eventTypes.indexOf(a)?e.events.push({eventType:a,callback:c}):console.warn(a+" is not in eventTypes!")}),this},e=function(a,c){var d=this.fixed?0:b.transX,e=this.fixed?0:b.transY,f=a>this.startX+this.moveX+d,g=a<this.startX+this.width+this.moveX+d,h=c>this.startY+this.moveY+e,i=c<this.startY+this.height+this.moveY+e;switch(this.type){case"rectangle":case"image":case"text":return!!(f&&g&&h&&i);case"arc":return!!(Math.sqrt((a-this.x-this.moveX-d)*(a-this.x-this.moveX-d)+(c-this.y-this.moveY-e)*(c-this.y-this.moveY-e))<=this.radius)}},f=function(a){if("[object Object]"===Object.prototype.toString.call(a))return a.drag&&(this.enableDrag=!0),a.changeIndex&&(this.enableChangeIndex=!0),a.fixed&&(this.fixed=!0),a.bg&&(this.isBg=!0),this},g=function(a){a&&"boolean"==typeof a&&(this.enableDrag=!0)},h=function(a){a&&"boolean"==typeof a&&(this.enableChangeIndex=!0)};return Object.assign({},c,{isDragging:!1,hasEnter:!1,hasDraggedIn:!1,moveX:0,moveY:0,on:d,isPointInner:e,config:f,drag:g,changeIndex:h})},function(){var a=function(a){var b=this,c=function(){var c=b.canvas,d=this.startX=a.startX,e=this.startY=a.startY,f=this.width=a.width,g=this.height=a.height;c.save(),c.translate(this.moveX,this.moveY),this.fixed&&c.translate(-b.transX,-b.transY),c.fillStyle=this.fillColor?this.fillColor:"#000",c.fillRect(d,e,f,g),c.restore()};return Object.assign({},b.display(a),{type:"rectangle",draw:c})};LCL.prototype.rectangle=a}(),function(){var a=function(a){var b=this,c=function(){var c=b.canvas,d=a.startX,e=a.startY,f=a.endX,g=a.endY;c.save(),c.translate(this.moveX,this.moveY),this.fixed&&c.translate(-b.transX,-b.transY),c.beginPath(),c.moveTo(d,e),c.lineTo(f,g),c.stroke(),c.closePath(),c.restore()};return Object.assign({},b.display(a),{type:"line",draw:c})};LCL.prototype.line=a}(),function(){var a=function(a){var b=this;a.src&&!~b.images.indexOf(a.src)&&b.images.push(a.src);var c=function(){var c=b.canvas,d=this.startX=a.startX,e=this.startY=a.startY,f=a.src;c.save(),c.translate(this.moveX,this.moveY),this.fixed&&c.translate(-b.transX,-b.transY),this.sliceWidth&&this.sliceHeight?c.drawImage(b.loader.getImg(f),this.sliceX,this.sliceY,this.sliceWidth,this.sliceHeight,d,e,this.width,this.height):c.drawImage(b.loader.getImg(f),d,e,this.width,this.height),c.restore()};return Object.assign({},b.display(a),{type:"image",draw:c})};LCL.prototype.image=a}(),function(){var a=function(a){function b(a,b,c){var d=a.measureText(b).width,e="...",f=a.measureText(e).width;if(d<=c||d<=f)return b;for(var g=b.length;d>=c-f&&g-- >0;)b=b.substring(0,g),d=a.measureText(b).width;return b+e}var c=this,d=function(){var d,e,f=c.canvas,g=this.startX=a.startX,h=this.startY=a.startY,i=a.width,j=a.height,k=a.paddingTop?a.paddingTop:0,l=a.center,m=a.font,n=a.type,o=a.color,p=this.text;n&&(f.save(),f.translate(this.moveX,this.moveY),this.fixed&&f.translate(-c.transX,-c.transY),this.backgroundColor&&(f.save(),f.fillStyle=this.backgroundColor,f.fillRect(g,h,i,j),f.restore()),f.font=m,f.textBaseline="top",d=f.measureText(p).width,e=b(f,p,i-8),"stroke"===n?(f.strokeStyle=o,l?d<i-8&&f.strokeText(e,g+4+(i-d-8)/2,h+k):f.strokeText(e,g+4,h+k)):(f.fillStyle=o,l?d<i-8&&f.fillText(e,g+4+(i-d-8)/2,h+k):f.fillText(e,g+4,h+k)),f.restore())};return Object.assign({},c.display(a),{type:"text",draw:d})};LCL.prototype.text=a}(),function(){var a=function(a){var b=this,c=function(){var c=b.canvas,d=this.x=a.x,e=this.y=a.y,f=this.color=a.color,g=a.type,h=this.radius=a.radius;c.save(),this.fixed&&c.translate(-b.transX,-b.transY),c.translate(this.moveX,this.moveY),c.beginPath(),c.arc(d,e,h,0,2*Math.PI,!1),"fill"===g?(c.fillStyle=f,c.fill()):(c.strokeStyle=f,c.stroke()),c.closePath(),c.restore()};return Object.assign({},b.display(a),{type:"arc",draw:c})};LCL.prototype.arc=a}(),LCL.prototype.event=function(a){return{getPos:function(b){var b=b||event,c=b.pageX-a.element.offsetLeft,d=b.pageY-a.element.offsetTop;return{x:c,y:d}},triggerEvents:function(){var b=a.objects.some(function(a){return!!a.events&&"[object Array]"===Object.prototype.toString.call(a.events)&&!a.isBg||a.enableDrag});if(b){var c=a.objects.some(function(a){return a.events&&a.events.some(function(a){return"mouseenter"===a.eventType||"mousemove"===a.eventType})&&!a.isBg});c&&this.mouseEnterOrMove(),a.utils.bind(a.element,"mousedown",this.mouseDown.bind(this))}},mouseEnterOrMove:function(){var b;a.utils.bind(a.element,"mousemove",function(c){var d=a._event.getPos(c).x,e=a._event.getPos(c).y;b=a.objects.some(function(a){return a.isDragging});var f=a._objects.filter(function(a){return a.isPointInner(d,e)&&!a.isBg});if(b){f&&f.length>1&&f[1].events&&f[1].events.forEach(function(a){"dragin"!==a.eventType||f[1].hasDraggedIn||(f[1].hasDraggedIn=!0,a.callback&&a.callback())});var g=function(a){a.hasDraggedIn&&a.events.forEach(function(a){"dragout"===a.eventType&&a.callback&&a.callback()}),a.hasDraggedIn=!1};a._objects.some(function(a){return a.hasDraggedIn&&(!a.isPointInner(d,e)||f[1]!==a)&&g(a)})}else{f&&f.length>0&&f[0].events&&f[0].events.forEach(function(a){"mouseenter"!==a.eventType||f[0].hasEnter?"mousemove"===a.eventType&&a.callback&&a.callback():(f[0].hasEnter=!0,a.callback&&a.callback())});var h=function(a){a.hasEnter&&a.events.forEach(function(a){"mouseleave"===a.eventType&&a.callback&&a.callback()}),a.hasEnter=!1};a._objects.some(function(a){return a.hasEnter&&(!a.isPointInner(d,e)||f[0]!==a)&&h(a)})}})},mouseDown:function(b){var c,d,e,f,g=this,h=a.objects.some(function(a){return!!a.enableDrag}),i=a._event.getPos(b).x,j=a._event.getPos(b).y;g.cacheX=i,g.cacheY=j;var k=a._objects.filter(function(a){return a.isPointInner(i,j)&&!a.isBg});if(k&&k.length>0&&(k[0].enableChangeIndex&&g.changeOrder(k[0]),k[0].events&&k[0].events.some(function(a){return"mousedown"===a.eventType&&a.callback&&a.callback()})),h){c=a._objects.filter(function(a){return a.isPointInner(i,j)&&!a.isBg}),d=c.length>0&&c[0].events&&c[0].events.some(function(a){return"drag"===a.eventType&&(e=a.callback),"drag"===a.eventType}),hasEventDragEnd=c.length>0&&c[0].events&&c[0].events.some(function(a){return"dragend"===a.eventType&&(f=a.callback),"dragend"===a.eventType});var l=function(b){var f=a._event.getPos(b).x,h=a._event.getPos(b).y;c[0].moveX=c[0].moveX+f-g.cacheX,c[0].moveY=c[0].moveY+h-g.cacheY,d&&e(),a.drawUtils.redraw(),g.cacheX=f,g.cacheY=h,c[0].isDragging=!0},m=function(b){var d=a._event.getPos(b).x,e=a._event.getPos(b).y,g=a._objects.filter(function(a){return a.isPointInner(d,e)&&!a.isBg});if(g&&g.length>1&&g[1].hasDraggedIn){g[1].hasDraggedIn=!1;var h=g[1].events.some(function(a){return"drop"===a.eventType&&a.callback&&a.callback(g[0])});!h&&g[1].events.some(function(a){return"dragout"===a.eventType&&a.callback&&a.callback()})}hasEventDragEnd&&f(),a.utils.unbind(document,"mousemove",l),a.utils.unbind(document,"mouseup",m),c[0].isDragging=!1};c&&c.length>0&&c[0].enableDrag&&(a.utils.bind(document,"mousemove",l),a.utils.bind(document,"mouseup",m))}if(a.enableGlobalTranslate&&!(c&&c.length>0)){var n=function(b){var c=a._event.getPos(b).x,d=a._event.getPos(b).y;a.transX=a.transX+c-g.cacheX,a.transY=a.transY+d-g.cacheY,a.drawUtils.redraw(),g.cacheX=c,g.cacheY=d},o=function(){a.utils.unbind(document,"mousemove",n),a.utils.unbind(document,"mouseup",o)};a.utils.bind(document,"mousemove",n),a.utils.bind(document,"mouseup",o)}},changeOrder:function(b){var c=a.objects.indexOf(b),d=a.objects[c];a.objects.splice(c,1),a.objects.push(d),a._objects=a.utils.reverse(a.objects),a.drawUtils.redraw()}}},LCL.prototype.utils={},LCL.prototype.utils.bind=function(a,b,c){try{return window.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c,a}catch(a){console.log(a)}},LCL.prototype.utils.unbind=function(a,b,c){try{window.removeEventListener?a.removeEventListener(b,c,!1):window.detachEvent?a.detachEvent(b,c):a["on"+b]=""}catch(a){console.log(a)}},LCL.prototype.utils.reverse=function(a){for(var b=a.length,c=[],d=0;d<b;d++)c[d]=a[b-d-1];return c},LCL.prototype.utils.imageLoader=function(){this.imageList=new Array,this.loadNum=0},LCL.prototype.utils.imageLoader.prototype={ready:function(a){var b=this;this.imageList.forEach(function(a){b.loadImg(a)});var c=setInterval(function(){b.loadNum===b.imageList.length&&(clearInterval(c),a&&a())},50)},loadImg:function(a){var b=this,c=setInterval(function(){a.complete===!0&&(b.loadNum++,clearInterval(c))},50)},addImg:function(a){var b=this;a.forEach(function(a){var c=new Image;c.src=a,c.name=a,c.loaded=!1,b.imageList.push(c)})},getImg:function(a){var b;return this.imageList.forEach(function(c){c.name==a&&(b=c)}),b}},function(){var a=0,b=["ms","moz","webkit","o"];try{for(var c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}catch(a){console.log(a)}}(),"object"==typeof exports&&"object"==typeof module?module.exports=LCL:window.LCL=LCL}();