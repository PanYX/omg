/*!
 * @Project: lcl
 * @Version: v1.0.1 
 * @Author: PengJiyuan 
 * @Date: 2016-12-29
 * @license: MIT
 *
 * @homepage: https://github.com/PengJiyuan/LCL#readme
 */
!function(a){var b={version:"1.0.1",objects:[],canvas:null,transX:0,transY:0,scale:1,drawUtils:{},eventTypes:["mousedown","mouseup","mouseenter","mouseleave","mousemove"],core:function(a){return a instanceof Object?(b.element=this.element=a.element,this.canvas=b.canvas=this.element.getContext("2d"),a.element.width=this.width=b.width=a.width,a.element.height=this.height=b.height=a.height,b.drawUtils.clear=this.clear,b.drawUtils.draw=this.draw,b.drawUtils.redraw=this.redraw,void(b.changeIndex=a.changeIndex)):void console.warn("no canvas element!")},init:function(a){return new b.core(a)}};b.core.prototype={addChild:function(a){b.objects.push(a)},show:function(){b.drawUtils.draw(),b.event.triggerEvents()},draw:function(){b.objects.forEach(function(a){a.draw()})},redraw:function(){b.drawUtils.clear(),b.canvas.save(),b.canvas.translate(b.transX,b.transY),b.canvas.scale(b.scale,b.scale),b.drawUtils.draw(),b.canvas.restore()},clear:function(){b.canvas.clearRect(0,0,b.width,b.height)},animate:function(a,c){b.event.triggerEvents();var d=(new Date).getTime(),e=function(){a(),b[d]=requestAnimationFrame(e)};return e(),d},stop:function(a){cancelAnimationFrame(b[a])},dragCanvas:function(a){if("boolean"==typeof a&&a){var c=this,d=function(a){c.cacheX=b.event.getPos(a).x,c.cacheY=b.event.getPos(a).y,b.bind(document,"mousemove",e),b.bind(document,"mouseup",f)},e=function(a){var d=b.event.getPos(a).x,e=b.event.getPos(a).y;b.transX=b.transX+d-c.cacheX,b.transY=b.transY+e-c.cacheY,c.redraw(),c.cacheX=d,c.cacheY=e},f=function(){b.unbind(document,"mousemove",e),b.unbind(document,"mouseup",f)};b.bind(b.element,"mousedown",d)}},scaleCanvas:function(a){if("boolean"==typeof a&&a){var c=this;b.bind(this.element,"wheel",function(a){a.deltaY<0?b.scale<=3&&(b.scale+=.02,c.redraw()):b.scale>.5&&(b.scale-=.02,c.redraw())})}}},b.display=function(a){var c={startX:a.startX,startY:a.startY,width:a.width,height:a.height,fillColor:a.fillColor},d=function(a,c){if(!a)throw"no eventTypes defined!";if(!c||"function"!=typeof c)throw"you need defined a callback!";this.events=this.events||[];var d=a.split(" "),e=this;return d.forEach(function(a){~b.eventTypes.indexOf(a)?e.events.push({eventType:a,callback:c}):console.warn(a+" is not in eventTypes!")}),this},e=function(a,c){var d=a>this.startX*b.scale+b.transX+this.moveX,e=a<(this.startX+this.width)*b.scale+b.transX+this.moveX,f=c>this.startY*b.scale+b.transY+this.moveY,g=c<(this.startY+this.height)*b.scale+b.transY+this.moveY;switch(this.type){case"rectangle":return!!(d&&e&&f&&g)}},f=function(a){a&&"boolean"==typeof a&&(this.enableDrag=!0)},g=function(a){a&&"boolean"==typeof a&&(this.enableChangeIndex=!0)};return Object.assign({},c,{hasEnter:!1,rotate:0,moveX:0,moveY:0,on:d,isPointInner:e,drag:f,changeIndex:g})},function(){var a=function(a){var c=function(){var c=b.canvas,d=a.startX,e=a.startY,f=a.width,g=a.height;c.save(),c.translate(d+f/2+this.moveX,e+g/2+this.moveY),c.rotate(Math.PI/180*this.rotate),c.translate(-(d+f/2+this.moveX),-(e+g/2+this.moveY)),c.translate(this.moveX,this.moveY),c.fillStyle=this.fillColor?this.fillColor:"#000",c.fillRect(d,e,f,g),c.restore()};return Object.assign({},b.display(a),{type:"rectangle",draw:c})};b.rectangle=a}(),function(){var a=function(a){var c=function(){var c=b.canvas,d=a.startX,e=a.startY,f=a.endX,g=a.endY;c.save(),c.translate(d+(f-d)/2,e+(g-e)/2),c.rotate(Math.PI/180*this.rotate),c.translate(-(d+(f-d)/2),-(e+(g-e)/2)),c.translate(this.moveX,this.moveY),c.beginPath(),c.moveTo(d,e),c.lineTo(f,g),c.stroke(),c.closePath(),c.restore()};return Object.assign({},b.display(a),{type:"line",draw:c})};b.line=a}(),b.event=function(){return{getPos:function(a){var a=a||event,c=a.pageX-b.element.offsetLeft,d=a.pageY-b.element.offsetTop;return{x:c,y:d}},triggerEvents:function(){b._objects=b.reverse(b.objects);var a=b.objects.some(function(a){return!!a.events&&"[object Array]"===Object.prototype.toString.call(a.events)});if(a){var c=b.objects.some(function(a){return a.events&&a.events.some(function(a){return"mouseenter"===a.eventType||"mousemove"===a.eventType})});c&&this.mouseEnterOrMove(),b.bind(b.element,"mousedown",this.mouseDown.bind(this))}},mouseEnterOrMove:function(){b.bind(b.element,"mousemove",function(a){var c=b.event.getPos(a).x,d=b.event.getPos(a).y,e=b._objects.filter(function(a){return a.events&&a.events.some(function(a){return"mouseenter"===a.eventType||"mousemove"===a.eventType})&&a.isPointInner(c,d)});e&&e.length>0&&(e[0].hasEnter=!0,e[0].events.forEach(function(a){"mouseenter"!==a.eventType&&"mousemove"!==a.eventType||a.callback&&a.callback()}));var f=function(a){a.hasEnter&&a.events.forEach(function(a){"mouseleave"===a.eventType&&a.callback&&a.callback()}),a.hasEnter=!1};b._objects.some(function(a){return a.hasEnter&&(!a.isPointInner(c,d)||e[0]!==a)&&f(a)})})},mouseDown:function(a){var c=this,d=b.objects.some(function(a){return!!a.enableDrag}),e=b.event.getPos(a).x,f=b.event.getPos(a).y;c.cacheX=e,c.cacheY=f;var g=b._objects.filter(function(a){return!!a.events&&"[object Array]"===Object.prototype.toString.call(a.events)&&a.events.some(function(a){return a.eventType="mousedown"})&&a.isPointInner(e,f)});if(g&&g.length>0&&(b.changeIndex&&c.changeOrder(g[0]),g[0].events.some(function(a){return"mousedown"===a.eventType&&a.callback&&a.callback()})),d){var h=b._objects.filter(function(a){return a.enableDrag&&a.isPointInner(e,f)}),i=function(a){var d=b.event.getPos(a).x,e=b.event.getPos(a).y;b.element.style.cursor="pointer",h[0].moveX=h[0].moveX+d-c.cacheX,h[0].moveY=h[0].moveY+e-c.cacheY,b.drawUtils.redraw(),c.cacheX=d,c.cacheY=e},j=function(){b.element.style.cursor="default",b.unbind(document,"mousemove",i),b.unbind(document,"mouseup",j)};h&&h.length>0&&(b.bind(document,"mousemove",i),b.bind(document,"mouseup",j))}},changeOrder:function(a){var c=b.objects.indexOf(a),d=b.objects[c];b.objects.splice(c,1),b.objects.push(d),b._objects=b.reverse(b.objects),b.drawUtils.redraw()}}}(),b.bind=function(b,c,d){return a.addEventListener?b.addEventListener(c,d,!1):b.attachEvent?b.attachEvent("on"+c,d):b["on"+c]=d,b},b.unbind=function(b,c,d){a.removeEventListener?b.removeEventListener(c,d,!1):a.detachEvent?b.detachEvent(c,d):b["on"+c]=""},b.reverse=function(a){for(var b=a.length,c=[],d=0;d<b;d++)c[d]=a[b-d-1];return c},function(){for(var b=0,c=["ms","moz","webkit","o"],d=0;d<c.length&&!a.requestAnimationFrame;++d)a.requestAnimationFrame=a[c[d]+"RequestAnimationFrame"],a.cancelAnimationFrame=a[c[d]+"CancelAnimationFrame"]||a[c[d]+"CancelRequestAnimationFrame"];a.requestAnimationFrame||(a.requestAnimationFrame=function(c,d){var e=(new Date).getTime(),f=Math.max(0,16-(e-b)),g=a.setTimeout(function(){c(e+f)},f);return b=e+f,g}),a.cancelAnimationFrame||(a.cancelAnimationFrame=function(a){clearTimeout(a)})}(),"object"==typeof exports&&"object"==typeof module?module.exports=b:a.LCL=b}(window);